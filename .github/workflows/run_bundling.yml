name: run_bundling
on:
  workflow_dispatch: 

jobs:
  bundle_windows_x86_64:
    runs-on: windows-2022 
    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: '1'
      CARGO_INCREMENTAL: 0
      ZED_WORKSPACE: ${{ github.workspace }}
    steps:
    - name: checkout_repo
      uses: actions/checkout@v4
      with:
        clean: false

    - name: setup_rust
      uses: dtolnay/rust-toolchain@stable

    - name: Patch Script (Disable Signing & Fix Paths)
      # 1. Меняем Community на Enterprise (путь к VS)
      # 2. Комментируем вызов CheckEnvironmentVariables (проверка ключей Azure)
      # 3. Отключаем саму функцию подписи (Sign-File), чтобы скрипт не падал в конце
      run: |
        $script = Get-Content script/bundle-windows.ps1
        $script = $script -replace 'Community', 'Enterprise'
        $script = $script -replace '(?<!#)CheckEnvironmentVariables', '# CheckEnvironmentVariables'
        $script = $script -replace '(?<!#)Sign-File', '# Sign-File'
        $script | Set-Content script/bundle-windows.ps1
      shell: pwsh

    - name: run_bundling
      # Запускаем сборку без проверок
      run: powershell script/bundle-windows.ps1 -Architecture x86_64
      shell: pwsh

    - name: upload_artifact
      uses: actions/upload-artifact@v4
      with:
        name: Zed-Windows-Bypassed
        # В Windows версии после бандлинга файл обычно лежит в корне target или в release
        path: target/release/zed.exe 
        if-no-files-found: warn
