name: run_bundling
on:
  workflow_dispatch: 

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: '1'
  CARGO_INCREMENTAL: 0
  CARGO_HOME: D:\c
  ZED_WORKSPACE: ${{ github.workspace }}
  # Пустышки для подстраховки
  TIMESTAMP_SERVER: "http://timestamp.digicert.com"
  FILE_DIGEST: "SHA256"

jobs:
  bundle_windows_x86_64:
    runs-on: windows-2022 
    defaults:
      run:
        shell: pwsh
    steps:
    - name: Enable Long Paths
      run: |
        reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
        git config --global core.longpaths true

    - name: checkout_repo
      uses: actions/checkout@v4
      with:
        clean: false

    - name: setup_rust
      uses: dtolnay/rust-toolchain@stable

    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "."

    - name: Patch Script (Safe Bypass)
      run: |
        $path = "script/bundle-windows.ps1"
        (Get-Content $path) | ForEach-Object {
            $line = $_
            # 1. Исправляем путь к Visual Studio
            $line = $line -replace 'Community', 'Enterprise'
            
            # 2. Комментируем ТОЛЬКО вызовы функций (строки, которые состоят только из названия)
            # Это не тронет строки "function Check... {" и не сломает синтаксис
            if ($line -match '^\s*(CheckEnvironmentVariables|Sign-File)\s*$') {
                $line = "# bypassed: " + $line
            }
            
            # 3. Пропускаем лицензии
            $line = $line -replace '\. script/generate-licenses\.ps1', '# Skip licenses'
            
            $line
        } | Set-Content $path
        
        # 4. Полностью обнуляем все скрипты подписи, чтобы они не могли выдать ошибку
        Get-ChildItem -Recurse -Filter "sign.ps1" | ForEach-Object { Set-Content $_.FullName -Value "exit 0" }
        
        # 5. Заглушка для файла лицензий
        if (!(Test-Path "assets/licenses.md")) { New-Item -Path "assets/licenses.md" -Value "Bypass" -Force }
      shell: pwsh

    - name: run_bundling
      # Мы разрешаем продолжить, даже если скрипт бандлера в конце на чем-то споткнется
      continue-on-error: true
      run: pwsh script/bundle-windows.ps1 -Architecture x86_64

    - name: upload_artifact
      # Этот шаг выполнится ВСЕГДА, так как zed.exe уже готов к этому моменту
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Zed-Windows-Bypassed
        path: |
          target/x86_64-pc-windows-msvc/release/zed.exe
          target/release/zed.exe
          inno/x86_64/bin/zed.exe
        if-no-files-found: warn
